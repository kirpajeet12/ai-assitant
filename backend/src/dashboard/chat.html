<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Store AI Chat Test</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px; }
    .wrap { max-width: 720px; margin: 0 auto; background:#fff; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.08); overflow:hidden; }
    .top { padding:14px 16px; border-bottom:1px solid #eee; font-weight:600; display:flex; gap:10px; align-items:center; }
    .top input { padding:8px 10px; border:1px solid #ddd; border-radius:8px; width: 220px; }
    .chat { height: 520px; overflow:auto; padding:16px; background:#fafafa; }
    .row { margin: 10px 0; display:flex; }
    .bot { justify-content:flex-start; }
    .me { justify-content:flex-end; }
    .bubble { max-width: 78%; padding:10px 12px; border-radius: 12px; line-height: 1.35; white-space: pre-wrap; }
    .bot .bubble { background:#fff; border:1px solid #e6e6e6; }
    .me .bubble { background:#d9ecff; }
    .bar { display:flex; gap:10px; padding:12px; border-top:1px solid #eee; background:#fff; }
    .bar input { flex:1; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    .bar button { padding:10px 16px; border:0; border-radius:10px; background:#1677ff; color:#fff; cursor:pointer; }
    .bar button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>Chat Test</div>
      <input id="storePhone" placeholder="Store phone (optional)" />
      <button id="startBtn">Start</button>
    </div>

    <div id="chat" class="chat"></div>

    <div class="bar">
      <input id="msg" placeholder="Type your order..." />
      <button id="sendBtn" disabled>Send</button>
    </div>
  </div>

  <script>
    let sessionId = null;

    const chatEl = document.getElementById("chat");
    const msgEl = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");
    const startBtn = document.getElementById("startBtn");
    const storePhoneEl = document.getElementById("storePhone");

    function addBubble(text, who="bot") {
      const row = document.createElement("div");
      row.className = "row " + (who === "me" ? "me" : "bot");
      const b = document.createElement("div");
      b.className = "bubble";
      b.textContent = text;
      row.appendChild(b);
      chatEl.appendChild(row);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function start() {
      chatEl.innerHTML = "";
      addBubble("Starting sessionâ€¦", "bot");

      const body = {
        storePhone: storePhoneEl.value.trim() || undefined,
        from: "web-user"
      };

      const r = await fetch("/api/chat/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const data = await r.json();
      if (!r.ok) {
        chatEl.innerHTML = "";
        addBubble(data.error || "Failed to start.", "bot");
        return;
      }

      sessionId = data.sessionId;
      chatEl.innerHTML = "";
      addBubble(data.message, "bot");
      sendBtn.disabled = false;
      msgEl.focus();
    }

    async function send() {
      const text = msgEl.value.trim();
      if (!text) return;

      addBubble(text, "me");
      msgEl.value = "";

      const r = await fetch("/api/chat/message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, text })
      });

      const data = await r.json();
      if (!r.ok) {
        addBubble(data.error || "Something went wrong.", "bot");
        return;
      }

      addBubble(data.message, "bot");
    }

    startBtn.addEventListener("click", start);
    sendBtn.addEventListener("click", send);
    msgEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    // Auto-start
    start();
  </script>
</body>
</html>
